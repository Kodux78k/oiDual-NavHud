<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL — Unified OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#020202">
  <meta name="description" content="DUAL Unified — Code Vault & Runtime Environment">

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <!-- Tailwind (Utility only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* =============== CORE THEME =============== */
    :root {
      --bg: #030304;
      --glass: rgba(10, 10, 12, 0.65);
      --glass-solid: rgba(15, 15, 20, 0.95);
      --border: rgba(255, 255, 255, 0.08);
      --accent: #00f2ff;
      --purple: #bd00ff;
      --warn: #ff3333;
      --success: #00ff9d;
      --font-ui: 'Inter', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background: var(--bg);
      color: #eec;
      font-family: var(--font-ui);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* Background Animation Canvas */
    #bgCanvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.4;
    }

    /* Common Utils */
    .hidden { display: none !important; }
    .glass-panel {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: #ccc;
    }
    .btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .btn:active { transform: scale(0.96); }
    .btn.primary { background: #fff; color: #000; border-color: #fff; }
    .btn.primary:hover { background: #ddd; }
    .btn.accent { border-color: var(--accent); color: var(--accent); }
    .btn.accent:hover { background: rgba(0, 242, 255, 0.1); }
    .btn.warn { border-color: var(--warn); color: var(--warn); }
    .btn.warn.active { background: var(--warn); color: #000; }

    /* Inputs */
    input, textarea {
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--border);
      color: #fff;
      border-radius: 6px;
      padding: 10px;
      font-family: var(--font-code);
      width: 100%;
      outline: none;
    }
    input:focus, textarea:focus { border-color: var(--accent); }

    /* =============== NUCLEUS (Toggle) =============== */
    .nucleus-wrapper {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    body.os-active .nucleus-wrapper {
      top: 40px;
      transform: translate(-50%, 0) scale(0.8);
    }

    .nucleus-btn {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: #080808;
      border: 1px solid #333;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
      transition: all 0.3s;
    }
    .nucleus-btn:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
    
    .ring {
      position: absolute; inset: -5px; border-radius: 50%;
      border: 1px solid transparent; border-top-color: var(--accent);
      animation: spin 4s linear infinite;
    }
    .ring.inner { inset: -12px; border-top-color: var(--purple); animation: spin 6s linear infinite reverse; opacity: 0.6; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* =============== UNO DASHBOARD (Editor) =============== */
    .dashboard-container {
      position: fixed;
      inset: 0;
      z-index: 40;
      padding: 120px 20px 20px;
      overflow-y: auto;
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
      transition: all 0.5s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    body.os-active .dashboard-container {
      opacity: 1;
      pointer-events: all;
      transform: translateY(0);
    }

    .card {
      width: 100%;
      max-width: 800px;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .module-list {
      display: flex; flex-direction: column; gap: 12px;
      width: 100%; max-width: 800px;
      padding-bottom: 100px;
    }

    .module-item {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s;
    }
    .module-header {
      padding: 16px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    .module-header:hover { background: rgba(255,255,255,0.04); }
    
    .module-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      background: #050505;
    }
    .module-item.open .module-content { max-height: 600px; border-top: 1px solid var(--border); }
    
    .editor-wrapper { padding: 16px; }

    /* =============== MONOLITH (Runtime) =============== */
    .monolith-overlay {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: #000;
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.7, 0, 0.3, 1);
      display: flex;
      flex-direction: column;
    }
    .monolith-overlay.active { transform: translateY(0); }

    .monolith-bar {
      height: 50px;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    iframe#runtimeFrame {
      flex: 1;
      width: 100%;
      border: none;
      background: #fff;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(50px);
      background: rgba(10,10,10,0.9);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 10px 20px;
      border-radius: 30px;
      font-family: var(--font-code);
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.3s;
      z-index: 200;
      display: flex; align-items: center; gap: 10px;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

  <!-- Dynamic Background -->
  <canvas id="bgCanvas"></canvas>

  <!-- NUCLEUS (Main Toggle) -->
  <div class="nucleus-wrapper">
    <div class="nucleus-btn" id="nucleusBtn" title="Ativar Sistema DUAL">
      <div class="ring"></div>
      <div class="ring inner"></div>
      <i data-lucide="power" color="#fff" size="24"></i>
    </div>
    <div id="sysStatus" style="margin-top:12px; font-family:var(--font-code); font-size:0.7rem; color:#666; letter-spacing:2px;">STANDBY</div>
  </div>

  <!-- UNO: DASHBOARD & EDITOR -->
  <div class="dashboard-container">
    
    <!-- Info Panel -->
    <div class="glass-panel card">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold tracking-tight">DUAL <span style="color:var(--accent)">// UNO</span></h1>
        <div class="text-right font-mono text-xs text-gray-500">
          <div id="clock">00:00:00</div>
          <div>SYSTEM READY</div>
        </div>
      </div>

      <div class="flex gap-2 mb-4">
        <input type="text" id="username" placeholder="Identidade do Operador" class="flex-1" value="Operador">
        <button id="voiceBtn" class="btn" title="Ativar Voz"><i data-lucide="mic"></i></button>
      </div>

      <div class="flex gap-2">
        <button id="newModuleBtn" class="btn primary flex-1"><i data-lucide="plus"></i> Novo Módulo</button>
        <button id="safeModeBtn" class="btn warn"><i data-lucide="shield"></i> <span id="safeLabel">SAFE</span></button>
      </div>

      <!-- Creator Area (Hidden by default) -->
      <div id="creatorArea" class="hidden mt-4 pt-4 border-t border-gray-800">
        <input id="modTitle" placeholder="Nome do Módulo (ex: Calculadora)" class="mb-2">
        <textarea id="modContent" rows="8" placeholder="Cole seu HTML/CSS/JS aqui..."></textarea>
        <div class="flex justify-end gap-2 mt-2">
          <button id="cancelCreate" class="btn">Cancelar</button>
          <button id="saveModule" class="btn accent">Salvar no Vault</button>
        </div>
      </div>
    </div>

    <!-- Files List -->
    <div id="vaultList" class="module-list">
      <!-- Generated via JS -->
    </div>

  </div>

  <!-- MONOLITH: RUNTIME ENVIRONMENT -->
  <div id="monolith" class="monolith-overlay">
    <div class="monolith-bar">
      <div class="flex items-center gap-2">
        <i data-lucide="cpu" color="var(--purple)" size="18"></i>
        <span class="font-mono text-sm tracking-widest text-gray-400">DUAL <span style="color:var(--purple)">// MONOLITH</span></span>
      </div>
      <div class="flex items-center gap-2">
         <span id="runtimeTitle" class="text-xs text-gray-500 mr-4 font-mono hidden sm:block">No Active Process</span>
        <button id="closeRuntime" class="btn" style="padding:4px 8px; font-size:12px"><i data-lucide="x" size="14"></i> ENCERRAR</button>
      </div>
    </div>
    <iframe id="runtimeFrame" sandbox="allow-scripts allow-forms allow-modals allow-pointer-lock allow-same-origin"></iframe>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i data-lucide="terminal" size="14"></i>
    <span id="toastMsg">Sistema Inicializado</span>
  </div>

  <script>
    /**
     * DUAL UNIFIED OS
     * Refactored for logic consistency and performance.
     */
    class DualOS {
      constructor() {
        this.state = {
          active: false,
          safeMode: true,
          user: localStorage.getItem('dual_user') || 'Operador',
          vault: JSON.parse(localStorage.getItem('dual_unified_vault') || '[]'),
          audioEnabled: true
        };

        // DOM Refs
        this.els = {
          body: document.body,
          nucleus: document.getElementById('nucleusBtn'),
          status: document.getElementById('sysStatus'),
          dashboard: document.querySelector('.dashboard-container'),
          creator: document.getElementById('creatorArea'),
          vaultList: document.getElementById('vaultList'),
          monolith: document.getElementById('monolith'),
          frame: document.getElementById('runtimeFrame'),
          toast: document.getElementById('toast'),
          msg: document.getElementById('toastMsg'),
          safeBtn: document.getElementById('safeModeBtn')
        };

        this.init();
      }

      init() {
        // Initialize Icons
        lucide.createIcons();

        // Clock
        setInterval(() => {
          const now = new Date();
          document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // Events
        this.els.nucleus.addEventListener('click', () => this.toggleSystem());
        
        document.getElementById('newModuleBtn').addEventListener('click', () => {
          this.playSound('click');
          this.els.creator.classList.remove('hidden');
          document.getElementById('modTitle').focus();
        });

        document.getElementById('cancelCreate').addEventListener('click', () => {
          this.els.creator.classList.add('hidden');
        });

        document.getElementById('saveModule').addEventListener('click', () => this.saveModule());

        document.getElementById('username').addEventListener('input', (e) => {
          this.state.user = e.target.value;
          localStorage.setItem('dual_user', this.state.user);
        });

        this.els.safeBtn.addEventListener('click', () => this.toggleSafeMode());
        
        document.getElementById('closeRuntime').addEventListener('click', () => this.closeMonolith());

        document.getElementById('voiceBtn').addEventListener('click', () => this.speak(`Sistemas nominais, ${this.state.user}.`));

        // Initial Render
        this.renderVault();
        this.initBackground();

        // If vault is empty, add welcome module
        if (this.state.vault.length === 0) {
          this.addWelcomeModule();
        }
      }

      toggleSystem() {
        this.playSound('hover');
        this.state.active = !this.state.active;
        this.els.body.classList.toggle('os-active', this.state.active);
        
        if (this.state.active) {
          this.els.status.innerText = "ONLINE";
          this.els.status.style.color = "var(--accent)";
          this.notify(`Bem vindo, ${this.state.user}`);
        } else {
          this.els.status.innerText = "STANDBY";
          this.els.status.style.color = "#666";
          this.els.creator.classList.add('hidden');
        }
      }

      toggleSafeMode() {
        this.state.safeMode = !this.state.safeMode;
        this.playSound('click');
        if(this.state.safeMode) {
          this.els.safeBtn.classList.remove('active');
          document.getElementById('safeLabel').innerText = "SAFE";
          this.notify("Filtros de Segurança: ATIVOS");
        } else {
          this.els.safeBtn.classList.add('active');
          document.getElementById('safeLabel').innerText = "RAW";
          this.notify("Filtros de Segurança: DESATIVADOS", true);
        }
      }

      saveModule() {
        const title = document.getElementById('modTitle').value.trim();
        const content = document.getElementById('modContent').value.trim();

        if (!title || !content) {
          this.notify("Erro: Campos vazios");
          return;
        }

        const newModule = {
          id: Date.now(),
          title,
          content,
          date: new Date().toLocaleDateString()
        };

        this.state.vault.unshift(newModule);
        this.persist();
        this.renderVault();
        
        // Reset form
        document.getElementById('modTitle').value = '';
        document.getElementById('modContent').value = '';
        this.els.creator.classList.add('hidden');
        this.notify("Módulo Cristalizado no Vault");
        this.playSound('success');
      }

      deleteModule(id) {
        if(!confirm("Deletar este módulo permanentemente?")) return;
        this.state.vault = this.state.vault.filter(m => m.id !== id);
        this.persist();
        this.renderVault();
        this.notify("Módulo Excluído");
      }

      executeModule(id) {
        const module = this.state.vault.find(m => m.id === id);
        if (!module) return;

        this.playSound('open');
        this.notify(`Inicializando Monolith: ${module.title}`);
        
        let finalCode = module.content;
        
        // Safety Check
        if (this.state.safeMode) {
          // Allow scripts generally but sanitize malicious triggers if needed
          // For a code playground, strictly sanitizing <script> often breaks the purpose,
          // so we rely on iframe sandbox attributes principally.
          // Using DOMPurify here primarily to prevent XSS attacks on the parent window context logic, 
          // though inside iframe it's contained.
          try {
             // Basic structure wrapper
             if(!finalCode.includes('<!doctype') && !finalCode.includes('<html')) {
                finalCode = `
                  <style>body{font-family:sans-serif;color:#333;padding:20px;}</style>
                  ${finalCode}
                `;
             }
          } catch(e) { console.error(e); }
        }

        // Open Monolith
        this.els.monolith.classList.add('active');
        document.getElementById('runtimeTitle').innerText = `RUNNING :: ${module.title.toUpperCase()}`;
        
        // Write to iframe
        const doc = this.els.frame.contentWindow.document;
        doc.open();
        doc.write(finalCode);
        doc.close();
      }

      closeMonolith() {
        this.els.monolith.classList.remove('active');
        this.playSound('click');
        // Clear iframe after delay to prevent flashing
        setTimeout(() => {
          this.els.frame.src = 'about:blank';
          document.getElementById('runtimeTitle').innerText = "No Active Process";
        }, 500);
      }

      renderVault() {
        this.els.vaultList.innerHTML = '';
        this.state.vault.forEach(mod => {
          const el = document.createElement('div');
          el.className = 'module-item';
          el.innerHTML = `
            <div class="module-header" onclick="dual.toggleItem(this)">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-blue-400">
                  <i data-lucide="box" size="16"></i>
                </div>
                <div>
                  <div class="font-bold text-sm text-gray-200">${mod.title}</div>
                  <div class="text-xs text-gray-500 font-mono">${mod.date}</div>
                </div>
              </div>
              <i data-lucide="chevron-down" size="16" class="text-gray-500"></i>
            </div>
            <div class="module-content">
              <div class="editor-wrapper">
                <textarea class="text-xs font-mono text-green-400 bg-black border-none mb-3 p-2 rounded h-32" readonly>${mod.content.replace(/</g, '&lt;')}</textarea>
                <div class="flex gap-2">
                  <button class="btn primary flex-1" onclick="dual.executeModule(${mod.id})"><i data-lucide="play" size="14"></i> EXECUTAR</button>
                  <button class="btn warn" onclick="dual.deleteModule(${mod.id})"><i data-lucide="trash-2" size="14"></i></button>
                </div>
              </div>
            </div>
          `;
          this.els.vaultList.appendChild(el);
        });
        lucide.createIcons();
      }

      toggleItem(header) {
        const item = header.parentElement;
        item.classList.toggle('open');
      }

      addWelcomeModule() {
        const welcome = {
          id: 1,
          title: "Intro do Sistema",
          date: new Date().toLocaleDateString(),
          content: `
<h1>Olá, Mundo DUAL</h1>
<p>Este é o ambiente de execução MONOLITH.</p>
<button onclick="alert('Sistema Operacional')">Clique Aqui</button>
<style>
  body { background: #111; color: #fff; font-family: sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
  button { padding: 10px 20px; background: cyan; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:10px; }
</style>
          `.trim()
        };
        this.state.vault.push(welcome);
        this.persist();
        this.renderVault();
      }

      persist() {
        localStorage.setItem('dual_unified_vault', JSON.stringify(this.state.vault));
      }

      notify(msg, isWarn = false) {
        this.els.msg.innerText = msg;
        this.els.toast.style.borderColor = isWarn ? 'var(--warn)' : 'var(--accent)';
        this.els.toast.style.color = isWarn ? 'var(--warn)' : 'var(--accent)';
        this.els.toast.classList.add('visible');
        clearTimeout(this.toastTimer);
        this.toastTimer = setTimeout(() => this.els.toast.classList.remove('visible'), 3000);
      }

      speak(text) {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'pt-BR';
          u.rate = 1.1;
          window.speechSynthesis.speak(u);
        }
      }

      playSound(type) {
        // Simple synth for UI feedback
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if(!AudioContext) return;
          const ctx = new AudioContext();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          if(type === 'hover') {
            osc.frequency.setValueAtTime(200, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.05);
          } else if(type === 'click') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
          } else if(type === 'open') {
             osc.type = 'sine';
             osc.frequency.setValueAtTime(200, ctx.currentTime);
             osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.3);
             gain.gain.setValueAtTime(0.1, ctx.currentTime);
             gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
             osc.start(); osc.stop(ctx.currentTime + 0.3);
          }
        } catch(e) {}
      }

      initBackground() {
        // Simple cyberpunk grid animation
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        
        let w, h;
        const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
        window.addEventListener('resize', resize);
        resize();

        const lines = [];
        for(let i=0; i<40; i++) lines.push({ x: Math.random()*w, y: Math.random()*h, s: Math.random()*2+0.5 });

        function animate() {
          ctx.fillStyle = '#020202';
          ctx.fillRect(0,0,w,h);
          
          // Draw grid
          ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
          ctx.lineWidth = 1;
          const gridSize = 50;
          
          // Perspective effect (simple)
          for(let y=0; y<h; y+=gridSize) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
          }
          for(let x=0; x<w; x+=gridSize) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
          }

          // Falling bits
          ctx.fillStyle = 'rgba(0, 242, 255, 0.3)';
          lines.forEach(l => {
            l.y += l.s;
            if(l.y > h) l.y = -10;
            ctx.fillRect(l.x, l.y, 2, 8);
          });
          
          requestAnimationFrame(animate);
        }
        animate();
      }
    }

    // Initialize Global
    const dual = new DualOS();
  </script>
</body>
</html>

